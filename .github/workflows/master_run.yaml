name: Nightly Tests Run Workflow

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

permissions:
  contents: write
  pages: write

jobs:
  # ============================================================
  # ðŸ§ª 1ï¸âƒ£ Matrix-style test execution
  # ============================================================
  test:
    name: Run ${{ matrix.name }}
    runs-on: ubuntu-latest
    timeout-minutes: 240
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN_DS_1_5 }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: UI_Tests_Part1
            path: >
              tests/test_cases/tests_ui/test_credits_purchase.py
              tests/test_cases/tests_ui/test_disks.py
              tests/test_cases/tests_ui/test_files.py
              tests/test_cases/tests_ui/test_organization_change_member_roles.py
              tests/test_cases/tests_ui/test_organization_remove_members.py
              tests/test_cases/tests_ui/test_organization_roles_access.py
              tests/test_cases/tests_ui/test_organization_structure_setup.py

          - name: UI_Tests_Part2
            path: >
              tests/test_cases/tests_ui/test_project_change_member_roles.py
              tests/test_cases/tests_ui/test_project_remove_members.py
              tests/test_cases/tests_ui/test_project_roles_access.py
              tests/test_cases/tests_ui/test_project_structure_setup.py
              tests/test_cases/tests_ui/test_secrets.py
              tests/test_cases/tests_ui/test_ui_login.py
              tests/test_cases/tests_ui/test_ui_signup.py

          - name: E2E_Tests_CLI_Tests
            path: "tests/test_cases/tests_cli tests/test_cases/tests_e2e"

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: .python-version

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install Playwright Chromium
        run: uv run python -m playwright install chromium --with-deps

      - name: Install Allure CLI
        run: |
          mkdir -p allure-bin
          curl -sSL -o allure.zip https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.zip
          unzip -q allure.zip -d allure-bin
          echo "$PWD/allure-bin/allure-2.27.0/bin" >> $GITHUB_PATH

      - name: Run ${{ matrix.name }}
        run: |
          mkdir -p reports/allure-results
          echo "Running ${{ matrix.name }} with:"
          echo "${{ matrix.path }}"
          uv run pytest $(echo "${{ matrix.path }}" | tr '\n' ' ') \
            -v --tb=short \
            --disable-warnings \
            --timeout=240 --timeout-method=signal \
            --log-cli-level=CRITICAL \
            --alluredir=reports/allure-results

      - name: Upload Allure results for ${{ matrix.name }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-allure-results
          path: reports/allure-results
          retention-days: 3

  # ============================================================
  # ðŸ§© 2ï¸âƒ£ Merge results + generate + deploy Allure report
  # ============================================================
  merge:
    name: Merge Allure Reports
    runs-on: ubuntu-latest
    needs: [test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Allure CLI
        run: |
          mkdir -p allure-bin
          curl -sSL -o allure.zip https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.zip
          unzip -q allure.zip -d allure-bin
          echo "$PWD/allure-bin/allure-2.27.0/bin" >> $GITHUB_PATH

      - name: Download Allure results from all jobs
        uses: actions/download-artifact@v6
        with:
          path: merged-results

      - name: Merge results
        run: |
          mkdir -p reports/allure-results
          cp -r merged-results/UI_Tests-allure-results/* reports/allure-results/ || true
          cp -r merged-results/E2E_Tests_CLI_Tests-allure-results/* reports/allure-results/ || true
          echo "Merged Allure results:"
          ls -l reports/allure-results

      - name: Copy Allure history from qa-regression-history branch
        run: |
          git fetch origin qa-regression-history
          mkdir -p reports/allure-results/history
          git clone --depth 1 --branch qa-regression-history https://github.com/${{ github.repository }} history-temp
          cp -r history-temp/history/* reports/allure-results/history/ || echo "No history found"
          rm -rf history-temp

      - name: Generate Allure report
        run: |
          allure generate reports/allure-results -o reports/allure-report --clean
          echo "âœ… Allure report generated"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports/allure-report
          publish_branch: gh-pages
          destination_dir: run-test-latest
          force: true

      - name: Push Allure history
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "ci@github.com"
          git fetch
          git checkout -B qa-regression-history origin/qa-regression-history || git checkout --orphan qa-regression-history
          mkdir -p history
          cp -r reports/allure-report/history/* history/ || true
          git add history
          git commit -m "Update Allure history from nightly run" || echo "No changes to commit"
          git push origin qa-regression-history --force

      - name: Upload final report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: reports/allure-report
          retention-days: 7
