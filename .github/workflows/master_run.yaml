name: Nightly Tests Run Workflow

on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * *'

permissions:
  contents: write
  pages: write

jobs:
  # ============================================================
  # üß™ 1Ô∏è‚É£ Matrix-style test execution
  # ============================================================
  test:
    name: Run ${{ matrix.name }}
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 240
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN_DS_1_5 }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: UI_Tests_Part1
            path: >
              tests/test_cases/tests_ui/test_credits_purchase.py
              tests/test_cases/tests_ui/test_disks.py
              tests/test_cases/tests_ui/test_files.py
              tests/test_cases/tests_ui/test_organization_change_member_roles.py
              tests/test_cases/tests_ui/test_organization_remove_members.py
              tests/test_cases/tests_ui/test_organization_roles_access.py
              tests/test_cases/tests_ui/test_organization_structure_setup.py
              tests/test_cases/tests_ui/test_project_change_member_roles.py

          - name: UI_Tests_Part2
            path: >
              tests/test_cases/tests_ui/test_project_remove_members.py
              tests/test_cases/tests_ui/test_project_roles_access.py
              tests/test_cases/tests_ui/test_project_structure_setup.py
              tests/test_cases/tests_ui/test_secrets.py
              tests/test_cases/tests_ui/test_ui_login.py
              tests/test_cases/tests_ui/test_ui_signup.py

          - name: E2E_Tests_CLI_Tests
            path: "tests/test_cases/tests_cli tests/test_cases/tests_e2e"

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version-file: .python-version

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install Playwright Chromium
        run: uv run python -m playwright install chromium --with-deps

      - name: Install Allure CLI
        run: |
          mkdir -p allure-bin
          curl -sSL -o allure.zip https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.zip
          unzip -q allure.zip -d allure-bin
          echo "$PWD/allure-bin/allure-2.27.0/bin" >> $GITHUB_PATH

      - name: Run ${{ matrix.name }}
        run: |
          mkdir -p reports/allure-results
          echo "Running ${{ matrix.name }} with:"
          echo "${{ matrix.path }}"
          uv run pytest $(echo "${{ matrix.path }}" | tr '\n' ' ') \
            -v --tb=short \
            --disable-warnings \
            --timeout=240 --timeout-method=signal \
            --log-cli-level=CRITICAL \
            --alluredir=reports/allure-results

      - name: Upload Allure results for ${{ matrix.name }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-allure-results
          path: reports/allure-results
          retention-days: 3

      - name: Clean job workspace
        if: always()
        run: |
          rm -rf ~/.cache ~/.npm ~/.local/share/Playwright reports || true
          df -h


  # ============================================================
  # üß© 2Ô∏è‚É£ Merge results + generate + deploy Allure report
  # ============================================================
  merge:
    name: Merge Allure Reports
    runs-on: ubuntu-latest-m
    needs: [test]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Allure CLI
        run: |
          mkdir -p allure-bin
          curl -sSL -o allure.zip https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.zip
          unzip -q allure.zip -d allure-bin
          echo "$PWD/allure-bin/allure-2.27.0/bin" >> $GITHUB_PATH

      - name: Check disk before merge
        run: df -h

      - name: Download Allure results from all jobs
        uses: actions/download-artifact@v6
        with:
          path: merged-results

      - name: Merge results
        run: |
          mkdir -p reports/allure-results
          cp -r merged-results/UI_Tests_Part1-allure-results/* reports/allure-results/ || true
          cp -r merged-results/UI_Tests_Part2-allure-results/* reports/allure-results/ || true
          cp -r merged-results/E2E_Tests_CLI_Tests-allure-results/* reports/allure-results/ || true
          echo "Merged Allure results:"
          ls -l reports/allure-results || true

      - name: Copy Allure history from qa-regression-history branch
        run: |
          git fetch origin qa-regression-history
          mkdir -p reports/allure-results/history
          git clone --depth 1 --branch qa-regression-history https://github.com/${{ github.repository }} history-temp
          cp -r history-temp/history/* reports/allure-results/history/ || echo "No history found"
          rm -rf history-temp

      - name: Generate Allure report
        run: |
          allure generate reports/allure-results -o reports/allure-report --clean
          echo "‚úÖ Allure report generated"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports/allure-report
          publish_branch: gh-pages
          destination_dir: run-test-latest
          force: true

      - name: Push Allure history
        if: always()
        run: |
          git config user.name "github-actions"
          git config user.email "ci@github.com"
          git fetch
          git checkout -B qa-regression-history origin/qa-regression-history || git checkout --orphan qa-regression-history
          mkdir -p history
          cp -r reports/allure-report/history/* history/ || true
          git add history
          git commit -m "Update Allure history from nightly run" || echo "No changes to commit"
          git push origin qa-regression-history --force

      - name: Upload final report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: reports/allure-report
          retention-days: 7

      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          REPORT_URL="https://neuro-inc.github.io/${{ github.event.repository.name }}/run-test-latest/index.html"
          SUMMARY_FILE="reports/allure-report/widgets/summary.json"

          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            TRIGGER="üïí Scheduled run (by GitHub Actions)"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TRIGGER="üë§ Manually triggered by ${{ github.actor }}"
          else
            TRIGGER="üîÅ Triggered by event: ${{ github.event_name }} (actor: ${{ github.actor }})"
          fi

          if [[ -f "$SUMMARY_FILE" ]]; then
            TOTAL=$(jq '.statistic.total // 0' "$SUMMARY_FILE")
            PASSED=$(jq '.statistic.passed // 0' "$SUMMARY_FILE")
            FAILED=$(jq '.statistic.failed // 0' "$SUMMARY_FILE")
            BROKEN=$(jq '.statistic.broken // 0' "$SUMMARY_FILE")
            SKIPPED=$(jq '.statistic.skipped // 0' "$SUMMARY_FILE")

            # Detect reruns count if available
            RERUNS=$(jq '.statistic.retries // .statistic.flaky // 0' "$SUMMARY_FILE")

            MESSAGE="*üìä Regression Test Report* :: $TRIGGER\n‚úÖ Passed: $PASSED | ‚ùå Failed: $FAILED | ‚ö†Ô∏è Broken: $BROKEN | üîÅ Reruns: $RERUNS | ‚è≠ Skipped: $SKIPPED | Total: $TOTAL"
          else
            MESSAGE="*üìä Regression Test Report* :: $TRIGGER\n‚ö†Ô∏è No summary file found."
          fi

          {
            echo -e "$MESSAGE"
            echo "<$REPORT_URL|View Full Allure Report>"
          } > slack_message.txt

          jq -Rs '{text: .}' < slack_message.txt > slack_payload.json
          curl -X POST -H 'Content-type: application/json' --data @slack_payload.json "$SLACK_WEBHOOK_URL"

      - name: Clean workspace
        if: always()
        run: |
          rm -rf allure-bin merged-results history-temp reports || true
          df -h
